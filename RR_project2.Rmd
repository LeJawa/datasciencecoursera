---
title: "Analysis on severe weather events in the USA"
author: "Luis Escobar Sawa"
date: "27/10/2022"
output:
  html_document:
  pdf_document:
subtitle: 'Reproducible Research: Peer-graded Assignment 2'
company: 'John Hopkins University'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

The goal of this study will be to try to address the following questions:

1.  Across the United States, which types of events are most harmful with respect to population health?
2.  Across the United States, which types of events have the greatest economic consequences?

We will use the storm database provided by the U.S. National Oceanic and Atmospheric Administration's (NOAA). This database reports estimates of any fatalities, injuries, and property damage caused by major storms and weather events.

## Data Processing

### Extracting the data

We are going to use the tidyverse library which is a collection of useful libraries like, dplyr, tibble, ggplot2 and readr, among others.

```{r libraries, message=FALSE, warning=FALSE}
library(tidyverse)
```

First we download the database if not already present in the repository.

```{r download_dataset, warning=FALSE}
dataDir <- "database/"
dataFile <- paste0(dataDir, "NOAA_stormdatabase.csv.bz2")
dataURL <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"

if(!dir.exists(dataDir)){
    dir.create(dataDir)
}

if(!file.exists(dataFile)){
    download.file(dataURL, dataFile)
}
```

We read the first observation to get the information on the columns present in the dataset.

```{r preread_dataset, cache=TRUE}
data <- read_csv(dataFile, n_max = 1, show_col_types = FALSE)
spec(data)
```

For this study, we will only keep the following columns:

-   BGN_DATE: The date of the start of the observation. While not completely relevant for this study, it will prove useful in some decisions.
-   EVTYPE: The type of the event observed. It is the main variable that we will be looking at.
-   FATALITIES: The number of fatalities caused by each event and is, of course, a key variable to investigate impact on population health.
-   INJURIES: The number of injuries caused by each event. This is the second variable we will use with regard to population health.
-   PROPDMG: The amount of property damage caused by the event in USD.
-   PROPDMGEXP: The magnitude of the property damage in the previous column.
-   CROPDMG: The amount of damage to crops caused by the event in USD.
-   CROPDMGEXP: The magnitude of the damage to crops in the previous column.

```{r read_dataset, cache=TRUE}
data <- read_csv(dataFile, col_types = cols_only(
  BGN_DATE = col_date("%m/%d/%Y 0:00:00"),
  EVTYPE = col_character(),
  FATALITIES = col_double(),
  INJURIES = col_double(),
  PROPDMG = col_double(),
  PROPDMGEXP = col_character(),
  CROPDMG = col_double(),
  CROPDMGEXP = col_character()))
```

Since we are only interested in events that caused population harm or property damage, we select only the events where all four columns (FATALITIES, INJURIES, PROPDMG and CROPDMG) are not equal to zero.

```{r subsetting_dataset, cache=TRUE}
data <- subset(data, FATALITIES > 0 | INJURIES > 0 | PROPDMG > 0 | CROPDMG > 0)
```

### Tidying the data

First, we will replace the *BGN_DATE* column by its year, dropping the information on month and day.

```{r add_year}

data <- mutate(data, YEAR=format(BGN_DATE, "%Y"), .keep = "unused")

```

The variables *PROPDMGEXP* and *CROPDMGEXP* contain the order of magnitude of the variables *PROPDMG* and *CROPDMG* respectively. Since it contains some letters as well as numbers, a direct conversion cannot be done. This is why we create a map, mapping the character to its corresponding number.
We then create new variables *REAL_PROPDMG* and *REAL_CROPDMG* with the quantities in single dollars.

```{r correct_dmg}

map <- data.frame(letter=c("b", "m", "k", "h", "0", "1", "2", "3", "4", "5", "6", "7", "8", "9"), 
                  value =c( 9 ,  6 ,  3 ,  2 , 0:9))

data$PROPDMGEXP <- map$value[match(tolower(data$PROPDMGEXP), map$letter)]
data$CROPDMGEXP <- map$value[match(tolower(data$CROPDMGEXP), map$letter)]

data <- data %>% mutate(REAL_PROPDMG = PROPDMG * 10^(PROPDMGEXP), .keep = "unused") %>%
                 mutate(REAL_CROPDMG = CROPDMG * 10^(CROPDMGEXP), .keep = "unused")

```

And lastly, we will clean the EVTYPE variable. Currently it contains `r n_distinct(unique(data$EVTYPE))` different events.

```{r EVTYPE_summary}
n_distinct(unique(data$EVTYPE))
```

::: columns
The NOAA has defined 48 different event types:

::: {.column width="25%"}
1.  Astronomical Low Tide
2.  Avalanche
3.  Blizzard
4.  Coastal Flood
5.  Cold/Wind Chill
6.  Debris Flow
7.  Dense Fog
8.  Dense Smoke
9.  Drought
10. Dust Devil
11. Dust Storm
12. Excessive Heat
:::

::: {.column width="25%"}
13. Extreme Cold/Wind Chill
14. Flash Flood
15. Flood
16. Frost/Freeze
17. Funnel Cloud
18. Freezing Fog
19. Hail
20. Heat
21. Heavy Rain
22. Heavy Snow
23. High Surf
24. High Wind
:::

::: {.column width="25%"}
25. Hurricane (Typhoon)
26. Ice Storm
27. Lake-Effect Snow
28. Lakeshore Flood
29. Lightning
30. Marine Hail
31. Marine High Wind
32. Marine Strong Wind
33. Marine Thunderstorm Wind
34. Rip Current
35. Seiche
36. Sleet
:::

::: {.column width="25%"}
37. Storm Surge/Tide
38. Strong Wind
39. Thunderstorm Wind
40. Tornado
41. Tropical Depression
42. Tropical Storm
43. Tsunami
44. Volcanic Ash
45. Waterspout
46. Wildfire
47. Winter Storm
48. Winter Weather
:::
:::

The following code tries to gather the different event types under the event types defined by the NOAA. The goal is to assign each of the original `r n_distinct(unique(data$EVTYPE))` to one or more NOAA events. The variable *evtypes_map* will map the original event types to a string that, when run over by a regex pattern, will find the corresponding NOAA events. If no event type could be ascertained, the event will be assigned to *"other"*.

```{r grouping_evtype, cache=TRUE}
evtypes_map <-  setNames(as_tibble(unique(data$EVTYPE)), c("EVTYPE")) %>% 
                mutate(replace=tolower(EVTYPE))  %>% 
                mutate(replace=gsub("  ", " ", replace)) %>%
                mutate(replace=gsub("avalance", "avalanche", replace)) %>%
                mutate(replace=gsub("cstl", "coastal", replace)) %>%
                mutate(replace=gsub("astronomical high tide", "coastal flood", replace)) %>%
                mutate(replace=gsub("coastal surge", "coastal flood", replace)) %>%
                mutate(replace=gsub("high tides", "coastal flood", replace)) %>%
                mutate(replace=gsub("coastalstorm", "coastal storm", replace)) %>%
                mutate(replace=gsub("hypothermia", "cold", replace)) %>%
                mutate(replace=gsub("low temperature", "cold", replace)) %>%
                mutate(replace=gsub("land", "debris flow", replace)) %>%
                mutate(replace=gsub("(mud|rock) *slide", "debris flow", replace)) %>%
                mutate(replace=gsub("fog", "dense fog", replace)) %>%
                mutate(replace=gsub("blowing dust", "dust storm", replace)) %>%
                mutate(replace=gsub("flash(?! flood)", "flash flood", replace, perl=TRUE)) %>%
                mutate(replace=gsub("dam break", "flood", replace)) %>%
                mutate(replace=gsub("fld", "flood", replace)) %>%
                mutate(replace=gsub("warm", "heat", replace)) %>%
                mutate(replace=gsub("hyperthermia", "heat", replace)) %>%
                mutate(replace=gsub("falling", "heavy", replace)) %>%
                mutate(replace=gsub("hvy", "heavy", replace)) %>%
                mutate(replace=gsub("rainfall", "heavy rain", replace)) %>%
                mutate(replace=gsub("(?<!heavy )rain", "heavy rain", replace, perl=TRUE)) %>%
                mutate(replace=gsub("precip", "heavy rain", replace)) %>%
                mutate(replace=gsub("heavy mix", "heavy rain", replace)) %>%
                mutate(replace=gsub("heavy shower", "heavy rain", replace)) %>%
                mutate(replace=gsub("excessive snow", "heavy snow", replace)) %>%
                mutate(replace=gsub("(?<!heavy )snow", "heavy snow", replace, perl=TRUE)) %>%
                mutate(replace=gsub("gusty wind", "heavy wind", replace)) %>%
                mutate(replace=gsub("hazardous", "high", replace)) %>%
                mutate(replace=gsub("heavy surf", "high surf", replace)) %>%
                mutate(replace=gsub("rough surf", "high surf", replace)) %>%
                mutate(replace=gsub("heavy swells", "high surf", replace)) %>%
                mutate(replace=gsub("heavy seas", "high surf", replace)) %>%
                mutate(replace=gsub("high waves", "high surf", replace)) %>%
                mutate(replace=gsub("rough seas", "high surf", replace)) %>%
                mutate(replace=gsub("rogue wave", "high surf", replace)) %>%
                mutate(replace=gsub("severe turbulence", "high surf", replace)) %>%
                mutate(replace=gsub("lake effect", "lake-effect", replace)) %>%
                mutate(replace=gsub("lake-effect heavy snow", "lake-effect snow", replace)) %>%
                mutate(replace=gsub("lake flood", "lakeshore flood", replace)) %>%
                mutate(replace=gsub("ligh*n*tn*ing", "lightning", replace)) %>%
                mutate(replace=gsub("mircoburst", "microburst", replace)) %>%
                mutate(replace=gsub("non-thunderstorm", "non thunderstorm", replace)) %>%
                mutate(replace=gsub("precipitation", "rain", replace)) %>%
                mutate(replace=gsub("gradient wind", "rip current", replace)) %>%
                mutate(replace=gsub("storm surge", "storm tide", replace)) %>%
                mutate(replace=gsub("heavy wind", "strong wind", replace)) %>%
                mutate(replace=gsub("non-severe wind damage", "strong wind", replace)) %>%
                mutate(replace=gsub("wind damage", "strong wind", replace)) %>%
                mutate(replace=gsub("^wind$", "strong wind", replace)) %>%
                mutate(replace=gsub("^winds$", "strong wind", replace)) %>%
                mutate(replace=gsub("storm force winds", "strong wind", replace)) %>%
                mutate(replace=gsub("non thunderstorm wind", "strong wind", replace)) %>%
                mutate(replace=gsub("swells", "surf", replace)) %>%
                mutate(replace=gsub("tstm", "thunderstorm", replace)) %>%
                mutate(replace=gsub("th*un*d*e+re*s*tr*or*ms*", "thunderstorm", replace)) %>%
                mutate(replace=gsub("downburst", "thunderstorm wind", replace)) %>%
                mutate(replace=gsub("microburst", "thunderstorm wind", replace)) %>%
                mutate(replace=gsub("thunderstorm wi$", "thunderstorm wind", replace)) %>%
                mutate(replace=gsub("thunderstormw", "thunderstorm wind", replace)) %>%
                mutate(replace=gsub("whirlwind", "thunderstorm wind", replace)) %>%
                mutate(replace=gsub("gustnado", "thunderstorm wind", replace)) %>%
                mutate(replace=gsub("wind storm", "thunderstorm wind", replace)) %>%
                mutate(replace=gsub("(^|severe )thunderstorm($| damage to)", "thunderstorm wind", replace)) %>%
                mutate(replace=gsub("coastal storm", "thunderstorm wind", replace)) %>%
                mutate(replace=gsub("torndao", "tornado", replace)) %>%
                mutate(replace=gsub("fire", "wildfire", replace)) %>%
                mutate(replace=gsub("windchill", "wind chill", replace)) %>%
                mutate(replace=gsub("wins", "wind", replace)) %>%
                mutate(replace=gsub("freezing drizzle", "winter weather", replace)) %>%
                mutate(replace=gsub("freezing rain", "winter weather", replace)) %>%
                mutate(replace=gsub("glaze", "winter weather", replace)) %>%
                mutate(replace=gsub("ice(?! storm)", "winter weather", replace, perl=TRUE)) %>%
                mutate(replace=gsub("icy roads", "winter weather", replace)) %>%
                mutate(replace=gsub("light snow", "winter weather", replace)) %>%
                mutate(replace=gsub("wintry mix", "winter weather", replace)) %>%
                mutate(replace=gsub("freezing spray", "winter weather", replace))

```

```{r multi-event_handling1, cache=TRUE}

NOAA_evtypes <- c("Astronomical Low Tide", "Avalanche", "Blizzard", "Coastal Flood", 
                  "Cold", "Wind Chill", "Debris Flow", "Dense Fog", "Dense Smoke", 
                  "Drought", "Dust Devil", "Dust Storm", "Excessive Heat", "Extreme Cold",
                  "Wind Chill", "Flash Flood", "Flood", "Frost", "Freeze", "Funnel Cloud", 
                  "Freezing Fog", "Hail", "Heat", "Heavy Rain", "Heavy Snow", "High Surf", 
                  "High Wind", "Hurricane", "Typhoon", "Ice Storm", "Lake-Effect Snow", 
                  "Lakeshore Flood", "Lightning", "Marine Hail", "Marine High Wind", 
                  "Marine Strong Wind", "Marine Thunderstorm Wind", "Rip Current",
                  "Seiche", "Sleet", "Storm Surge", "Storm Tide", "Strong Wind", 
                  "Thunderstorm Wind", "Tornado", "Tropical Depression", "Tropical Storm",
                  "Tsunami", "Volcanic Ash", "Waterspout", "Wildfire", "Winter Storm",
                  "Winter Weather", "Other")

noaa_evtypes <- tolower(NOAA_evtypes)
noaa_patterns <- paste0("(", paste(noaa_evtypes, collapse = "|"), ")")

# Event types that fail to match to NOAA event types are assigned to "other"
# Only 17 of the original events fall into this category for a total of 62 observations.
evtypes_map$replace[!grepl(noaa_patterns, evtypes_map$replace)] = "other"

data$EVTYPE <- evtypes_map$replace[match(data$EVTYPE, evtypes_map$EVTYPE)]

```

Some of the original events appear to belong to multiple NOAA events,  such as ICE STORM/FLASH FLOOD or HURRICANE OPAL/HIGH WINDS. To solve this issue, the original event will be divided into multiple parts and each will be assigned to a different individual NOAA event. This way the global impact of the event is preserved while also trying to keep all the original information.

```{r multi-event_handling2, cache=TRUE}

results <- list(evtype=unique(data$EVTYPE), 
                matches=regmatches(unique(data$EVTYPE),
                gregexec(noaa_patterns, unique(data$EVTYPE))))

addition <- tibble(
  YEAR = character(),
  EVTYPE = character(),
  FATALITIES = double(),
  INJURIES = double(),
  REAL_PROPDMG = double(),
  REAL_CROPDMG = double())

for(i in 1:nrow(data)){
  matches <- results$matches[results$evtype == data$EVTYPE[i]][[1]][1,]
  
  number <- length(matches)
  
  common_divisor <- number
  data$EVTYPE[i]       <- matches[1]
  
  if(number == 1){
    next
  }
  
  data$FATALITIES[i]   <- data$FATALITIES[i]   / common_divisor
  data$INJURIES[i]     <- data$INJURIES[i]     / common_divisor
  data$REAL_PROPDMG[i] <- data$REAL_PROPDMG[i] / common_divisor
  data$REAL_CROPDMG[i] <- data$REAL_CROPDMG[i] / common_divisor
  
  number <- number - 1
  
  for(j in 1:number){
    addition <- add_row(addition,
                    EVTYPE = matches[1+j],
                    FATALITIES = data$FATALITIES[i],
                    INJURIES = data$INJURIES[i],
                    REAL_PROPDMG = data$REAL_PROPDMG[i],
                    REAL_CROPDMG = data$REAL_CROPDMG[i],
                    YEAR = data$YEAR[i]
           )
  }
}

data <- rbind(data, addition)

```

## Explore the data

We are interested in total damage per event type and therefore a sum over all the observations per event type is required. However, we notice that the earlier years (1950s to 1980s) contain almost exclusively tornado events.
In order to investigate and later mitigate it, we will do the summation over event types as well as years.

```{r sum_over_years, warning=FALSE}
summary_per_year <- data %>% 
                    group_by(EVTYPE, YEAR) %>% 
                    summarise(FATALITIES=sum(FATALITIES, na.rm = TRUE), 
                              INJURIES=sum(INJURIES, na.rm = TRUE), 
                              PROPDMG=sum(REAL_PROPDMG, na.rm = TRUE), 
                              CROPDMG=sum(REAL_CROPDMG, na.rm = TRUE))

```




```{r}
summary_sum <- summary_per_year %>%
           group_by(EVTYPE) %>%
           summarise(FATALITIES=sum(FATALITIES, na.rm = TRUE), 
                     INJURIES=sum(INJURIES, na.rm = TRUE), 
                     PROPDMG=sum(PROPDMG, na.rm = TRUE), 
                     CROPDMG=sum(CROPDMG, na.rm = TRUE))


summary_mean <- summary_per_year %>%
                group_by(EVTYPE) %>%
                summarise(FATALITIES=mean(FATALITIES, na.rm = TRUE), 
                          INJURIES=mean(INJURIES, na.rm = TRUE), 
                          PROPDMG=mean(PROPDMG, na.rm = TRUE), 
                          CROPDMG=mean(CROPDMG, na.rm = TRUE))


summary2 <- summary %>% 
            pivot_longer(2:3, values_to = "quantity", names_to = "health_type") %>% 
            pivot_longer(2:3, values_to = "amount", names_to = "damage_type") %>%
            arrange(desc(quantity), amount)

summary_mean2 <- summary_mean %>% 
                 pivot_longer(2:3, values_to = "quantity", names_to = "health_type") %>% 
                 pivot_longer(2:3, values_to = "amount", names_to = "damage_type") %>%
                 arrange(desc(quantity), amount)


```

```{r}

ggplot(data=summary2, aes(x=reorder(EVTYPE, -quantity), y=quantity, fill=health_type)) + 
  geom_bar(stat = "identity") +
  theme_bw()


```

```{r}
ggplot(data=summary_mean2, aes(x=reorder(EVTYPE, -quantity), y=quantity, fill=health_type)) + 
  geom_bar(stat = "identity") +
  theme_bw()
```


## Results

You can also embed plots, for example:

```{r pressure, echo=FALSE}

```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
